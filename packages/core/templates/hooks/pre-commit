#!/bin/sh
# FoundrySpec GitOps Policy: Pre-Commit
# Enforces architectural integrity before allowing commits.

echo "üõ°Ô∏è  FoundrySpec GitOps: Verifying Architectural Integrity..."

# Detect if foundryspec is globally installed, otherwise use npx
if command -v foundryspec >/dev/null 2>&1; then
    FOUNDRY_CMD="foundryspec"
else
    FOUNDRY_CMD="npx foundryspec"
fi

# 1. Check for Drift
# We run the probe command. If it fails (exit code 1), we block the commit.
if ! $FOUNDRY_CMD probe; then
    echo "‚ùå GitOps Policy Violation: Architectural Drift Detected."
    echo "   Please run 'foundryspec design-feature' or update your spec/code to match."
    exit 1
fi

# 2. Check for Integrity & Broken Links
# We run the build command. If it fails (exit code 1), we block the commit.
if ! $FOUNDRY_CMD build; then
    echo "‚ùå GitOps Policy Violation: Build Integrity Check Failed."
    echo "   Please fix broken links or syntax errors in your specification."
    exit 1
fi

echo "‚úÖ Integrity Checks Passed. Committing..."
exit 0
