<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{categoryName}} - {{projectName}}</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom/dist/svg-pan-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      /* Premium Viewer Styles */
      /* Mindmap Custom Classes - Premium Palette */
      .mindmap-node-root > circle,
      .mindmap-node-root > text {
        fill: #ffffff !important;
        stroke: #38bdf8 !important;
        stroke-width: 3px !important;
        font-weight: 800 !important;
        color: #020617 !important;
      }

      .mindmap-node-l0 > rect {
        fill: #1e1b4b !important;
        stroke: #6366f1 !important;
        stroke-width: 2px !important;
      }
      .mindmap-node-l0 > text {
        fill: #e0e7ff !important;
        font-weight: 600 !important;
      }

      .mindmap-node-l1 > rect {
        fill: #0c4a6e !important;
        stroke: #0ea5e9 !important;
        stroke-width: 2px !important;
      }
      .mindmap-node-l1 > text {
        fill: #e0f2fe !important;
        font-weight: 600 !important;
      }

      .mindmap-node-l2 > rect {
        fill: #064e3b !important;
        stroke: #10b981 !important;
        stroke-width: 2px !important;
      }
      .mindmap-node-l2 > text {
        fill: #d1fae5 !important;
        font-weight: 600 !important;
      }

      .mindmap-node-l3 > rect {
        fill: #451a03 !important;
        stroke: #f59e0b !important;
        stroke-width: 2px !important;
      }
      .mindmap-node-l3 > text {
        fill: #fef3c7 !important;
        font-weight: 600 !important;
      }

      :root {
        --bg-primary: #020617;
        --bg-secondary: #0f172a;
        --accent: #38bdf8;
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --border: rgba(255, 255, 255, 0.08);
        --transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
        --overlay: rgba(2, 6, 23, 0.85);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      aside {
        width: 360px;
        background: var(--bg-secondary);
        border-right: 1px solid var(--border);
        overflow-y: auto;
        padding: 2rem;
        z-index: 10;
      }

      main {
        flex-grow: 1;
        position: relative;
        background: #000;
        display: flex;
        flex-direction: column;
        padding: 1.5rem;
        overflow: hidden;
      }

      .diagram-item {
        padding: 1.25rem;
        border: 1px solid var(--border);
        border-radius: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: var(--transition);
      }

      .diagram-item:hover {
        background: rgba(255, 255, 255, 0.05);
        transform: translateY(-2px);
      }

      .diagram-item.active {
        border-color: var(--accent);
        background: rgba(56, 189, 248, 0.1);
        box-shadow: 0 0 20px rgba(56, 189, 248, 0.1);
      }

      #mermaid-container {
        flex: 1;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border-radius: 2rem;
        overflow: hidden;
        transition: var(--transition);
        position: relative;
      }

      #mermaid-container * {
        max-width: none !important;
      }

      #mermaid-container .mermaid {
        width: 100% !important;
        height: 100% !important;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
        max-width: none !important;
      }

      /* Fullscreen Viewport Mode */
      #mermaid-container.fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        margin: 0;
        border-radius: 0;
        z-index: 2000;
      }

      .svg-pan-zoom-control {
        position: absolute !important;
      }

      /* Modal Styles */
      #modal-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--overlay);
        backdrop-filter: blur(8px);
        z-index: 3000;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      #modal-backdrop.open {
        display: flex;
        opacity: 1;
      }

      #modal-content {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 2rem;
        width: 90%;
        max-width: 800px;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        transform: scale(0.9);
        transition: transform 0.3s cubic-bezier(0.23, 1, 0.32, 1);
      }

      #modal-backdrop.open #modal-content {
        transform: scale(1);
      }

      .modal-header {
        padding: 2rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-body {
        padding: 2.5rem;
        overflow-y: auto;
        line-height: 1.7;
        font-size: 1.05rem;
      }

      .modal-body h1,
      .modal-body h2,
      .modal-body h3 {
        font-family: "Outfit", sans-serif;
        color: var(--accent);
        margin-top: 0;
      }

      .modal-body pre {
        background: rgba(0, 0, 0, 0.3);
        padding: 1.25rem;
        border-radius: 0.75rem;
        overflow-x: auto;
      }

      .close-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 2rem;
        cursor: pointer;
        line-height: 1;
        transition: var(--transition);
      }

      .close-btn:hover {
        color: var(--text-primary);
        transform: rotate(90deg);
      }

      /* Control Buttons */
      .controls {
        position: absolute;
        top: 2.5rem;
        right: 2.5rem;
        display: flex;
        gap: 1rem;
        z-index: 20;
      }

      .control-btn {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: 0.75rem 1.25rem;
        border-radius: 0.75rem;
        cursor: pointer;
        font-family: "Inter", sans-serif;
        font-weight: 600;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition);
        backdrop-filter: blur(4px);
      }

      .control-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--accent);
      }

      .fullscreen-exit-btn {
        display: none;
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 2001;
      }

      #mermaid-container.fullscreen ~ .fullscreen-exit-btn {
        display: block;
      }
    </style>
  </head>

  <body>
    <aside>
      <header>
        <h2
          style="
            font-family: 'Outfit', sans-serif;
            margin-bottom: 2rem;
            letter-spacing: -0.02em;
          "
        >
          {{categoryName}}
        </h2>
      </header>
      <div id="diagram-list"></div>
    </aside>
    <main>
      <div class="controls">
        <button class="control-btn" onclick="toggleFullscreen()">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"
            />
          </svg>
          Fullscreen
        </button>
      </div>
      <div id="mermaid-container">Select a diagram</div>
      <button
        class="control-btn fullscreen-exit-btn"
        onclick="toggleFullscreen()"
      >
        Exit Fullscreen
      </button>
    </main>

    <div id="modal-backdrop" onclick="closeModal(event)">
      <div id="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2
            id="modal-title"
            style="margin: 0; font-family: 'Outfit', sans-serif"
          >
            Details
          </h2>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div id="modal-body" class="modal-body">
          <!-- Content will be injected here -->
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const listContainer = document.getElementById("diagram-list");
        const mermaidContainer = document.getElementById("mermaid-container");

        try {
          const response = await fetch("diagrams.json");
          const diagrams = await response.json();

          if (diagrams.length === 0) {
            listContainer.innerHTML = "<p>No diagrams found.</p>";
            return;
          }

          diagrams.forEach((diag, index) => {
            const item = document.createElement("div");
            item.className = "diagram-item";
            item.innerHTML = `
                        <strong style="display: block; margin-bottom: 0.25rem;">${diag.title}</strong>
                        <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">${diag.description}</p>
                    `;
            item.onclick = () => loadDiagram(diag, item);
            listContainer.appendChild(item);

            if (index === 0) loadDiagram(diag, item);
          });
        } catch (err) {
          console.error("Failed to load diagrams:", err);
          listContainer.innerHTML = "<p>Error loading diagrams.json</p>";
        }

        mermaid.initialize({
          startOnLoad: false,
          theme: "default",
          flowchart: { useMaxWidth: false, htmlLabels: true },
          sequence: { useMaxWidth: false },
          gantt: { useMaxWidth: false },
        });

        // Expose these to the global scope
        window.loadDiagram = loadDiagram;
        window.closeModal = closeModal;
        window.handleFootnoteLink = handleFootnoteLink;
        window.toggleFullscreen = toggleFullscreen;

        function closeModal(e) {
          if (e && e.target !== document.getElementById("modal-backdrop"))
            return;
          const backdrop = document.getElementById("modal-backdrop");
          backdrop.classList.remove("open");
        }

        async function loadDiagram(diag, element) {
          document
            .querySelectorAll(".diagram-item")
            .forEach((el) => el.classList.remove("active"));
          element.classList.add("active");

          mermaidContainer.innerHTML = '<p style="color: black">Loading...</p>';
          try {
            const response = await fetch(diag.file);
            const code = await response.text();

            mermaidContainer.innerHTML = `<pre class="mermaid" style="width: 100%; height: 100%;">${code}</pre>`;
            await mermaid.run();

            const svg = mermaidContainer.querySelector("svg");
            if (svg) {
              // Reset mermaid's injected styles
              svg.removeAttribute("width");
              svg.removeAttribute("height");
              svg.style.width = "100%";
              svg.style.height = "100%";
              svg.style.maxWidth = "none";

              // Ensure the .mermaid pre/div also fills container
              const parent = svg.parentElement;
              if (parent && parent.classList.contains("mermaid")) {
                parent.style.width = "100%";
                parent.style.height = "100%";
              }

              svgPanZoom(svg, {
                zoomEnabled: true,
                controlIconsEnabled: true,
                fit: true,
                center: true,
                minZoom: 0.1,
                maxZoom: 10,
              });

              // Intercept link clicks in the SVG
              svg.addEventListener("click", (e) => {
                let target = e.target;
                while (target && target !== svg) {
                  if (target.tagName.toLowerCase() === "a") {
                    const href =
                      target.getAttribute("xlink:href") ||
                      target.getAttribute("href");
                    if (
                      href &&
                      (href.includes("/footnotes/") ||
                        href.includes("footnotes/"))
                    ) {
                      e.preventDefault();
                      handleFootnoteLink(href);
                      return;
                    }
                  }
                  target = target.parentElement;
                }
              });
            }
          } catch (err) {
            mermaidContainer.innerHTML = `<p style="color:red; padding: 2rem;">Error: ${err.message}</p>`;
          }
        }

        async function handleFootnoteLink(url) {
          const cleanUrl = url.startsWith("/") ? url : "/" + url;
          // Path is /footnotes/[category]/[nodeId].md
          try {
            const response = await fetch(cleanUrl);
            if (!response.ok)
              throw new Error(`Could not load footnote file: ${cleanUrl}`);
            const text = await response.text();

            const modalTitle = document.getElementById("modal-title");
            const modalBody = document.getElementById("modal-body");
            const backdrop = document.getElementById("modal-backdrop");

            // Extract node name from URL if possible
            const fileName = cleanUrl.split("/").pop().replace(".md", "");
            modalTitle.innerText = `Detail: ${fileName}`;
            modalBody.innerHTML = marked.parse(text);
            backdrop.classList.add("open");
          } catch (err) {
            console.error(err);
            alert("Error loading footnote: " + err.message);
          }
        }

        function toggleFullscreen() {
          const container = document.getElementById("mermaid-container");
          container.classList.toggle("fullscreen");

          // If exiting fullscreen, we might need to re-fit the SVG
          const svg = container.querySelector("svg");
          if (svg && window.svgPanZoom) {
            // Slight delay to allow CSS transitions or layout changes
            setTimeout(() => {
              const instance = svgPanZoom(svg);
              instance.resize();
              instance.fit();
              instance.center();
            }, 50);
          }
        }
      });
    </script>
  </body>
</html>
