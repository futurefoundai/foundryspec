<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{projectName}} - Diagram Viewer</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="index.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
  </head>
  <body>
    <div id="header">
      <button id="back-button">&larr;</button>
      <h1>{{projectName}}</h1>
      <div id="header-controls" style="display:flex; align-items:center; gap:10px; margin-left:auto; margin-right:20px;">
          <input type="text" id="search-input" placeholder="Search..." style="padding:5px; border-radius:4px; border:1px solid #ccc;">
          <button id="theme-toggle" onclick="toggleTheme()" style="background:none; border:none; color:var(--text-primary); font-size:1.2rem; cursor:pointer;">&#9728;</button>
      </div>
    </div>
    <div id="breadcrumb-bar">
      <div id="breadcrumbs"></div>
    </div>
    <div id="viewer">
      <div class="diagram-container" id="diagram-container"></div>
    </div>

    <div id="modal-backdrop" onclick="closeModal(event)">
      <div id="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2
            id="modal-title"
            style="
              margin: 0;
              font-family: 'Outfit', sans-serif;
              font-size: 1.25rem;
            "
          >
            Details
          </h2>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div id="modal-body" class="modal-body"></div>
      </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu">
      <div class="menu-item" id="menu-comments">Comments</div>
      <div class="menu-item" id="menu-footnotes">Footnotes</div>
      <div class="menu-item" id="menu-divider" style="height:1px; background:var(--border); margin:4px 0; opacity:0.3;"></div>
      <div class="menu-item" id="menu-data">Data Models</div>
      <div class="menu-item" id="menu-sequence">Sequences</div>
      <div class="menu-item" id="menu-flow">Flows</div>
      <div class="menu-item" id="menu-state">State Machines</div>
    </div>

    <!-- Context Sidebar -->
    <div id="context-sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3 id="sidebar-title">Node Context</h3>
            <button class="close-btn" onclick="closeSidebar()">&times;</button>
        </div>
        <div id="sidebar-content" class="sidebar-body">
            <!-- Dynamic Content -->
        </div>
        <div id="sidebar-footer" class="sidebar-footer" style="padding:1rem; border-top:1px solid var(--border); display:none;">
            <textarea id="sidebar-comment-input" placeholder="Add a comment or AI prompt..." rows="3" style="width:100%; padding:0.5rem; border:1px solid var(--border); border-radius:4px; background:var(--bg-primary); color:var(--text-primary); resize:vertical; font-family:inherit; font-size:0.9rem; margin-bottom:0.5rem;"></textarea>
            <button id="sidebar-save-btn" style="width:100%; background:var(--accent); color:#fff; border:none; padding:8px; border-radius:4px; font-weight:600; cursor:pointer;">Post Comment</button>
        </div>
    </div>

    <!-- Navigation Selection Modal -->
    <div id="nav-modal-backdrop" class="modal-backdrop" onclick="closeNavModal(event)">
      <div id="nav-modal-content" class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="nav-modal-title" style="margin:0; font-family:'Outfit',sans-serif; font-size:1rem;">Select Destination</h2>
            <button class="close-btn" onclick="closeNavModal()">&times;</button>
        </div>
        <div id="nav-modal-body" class="nav-modal-body"></div>
      </div>
    </div>

    <!-- Comment Overlay -->
    <div id="comment-overlay">
      <div id="comment-list"></div>
      <textarea class="comment-input" id="new-comment-input" placeholder="Enter feedback..." rows="3"></textarea>
      <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.5rem;">
        <button onclick="closeCommentOverlay()" style="background: transparent; border: none; color: #94a3b8; cursor: pointer; font-size: 0.8rem;">Cancel</button>
        <button id="save-comment-btn" style="background: #38bdf8; border: none; color: #0f172a; padding: 0.2rem 0.8rem; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.8rem;">Save</button>
      </div>
    </div>

    <!-- Initialization & External Logic -->
    <script>
      // Injected by FoundrySpec
      const idMap = {{idMap}};
      const projectName = "{{projectName}}";
      const projectId = "{{projectId}}";
      const projectVersion = "{{version}}";
    </script>
    <script src="index.js"></script>
  </body>
</html>
